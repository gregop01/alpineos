#!/usr/bin/env node
/**
 * Generate migration SQL to update RSTBC rec site booking_url to per-site
 * sitesandtrailsbc.ca/resource/{FOREST_FILE_ID} URLs.
 *
 * Fetches ArcGIS BC rec sites (points + polygons), builds a mapping of
 * coordinates -> FOREST_FILE_ID, then outputs UPDATE statements that match
 * locations by nearest coordinate.
 *
 * Run: node scripts/generate-rstbc-booking-urls.mjs > supabase/migrations/015_update_rstbc_booking_urls.sql
 */

const BC_REC_SITES_URL =
  'https://delivery.maps.gov.bc.ca/arcgis/rest/services/whse/bcgw_pub_whse_forest_tenure/MapServer/13/query';
const BC_REC_POLYGONS_URL =
  'https://delivery.maps.gov.bc.ca/arcgis/rest/services/whse/bcgw_pub_whse_forest_tenure/MapServer/5/query';
const MAX_RECORDS = 1000;

async function fetchJson(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${url}`);
  return res.json();
}

async function fetchArcGISPaginated(baseUrl, label) {
  const out = [];
  let offset = 0;
  while (true) {
    const params = new URLSearchParams({
      where: '1=1',
      outFields: '*',
      returnGeometry: 'true',
      outSR: '4326',
      f: 'geojson',
      resultRecordCount: String(MAX_RECORDS),
      resultOffset: String(offset),
    });
    const url = `${baseUrl}?${params}`;
    try {
      const data = await fetchJson(url);
      const features = data.features || [];
      if (features.length === 0) break;
      out.push(...features);
      if (features.length < MAX_RECORDS) break;
      offset += features.length;
    } catch (e) {
      console.error(`/* ${label} fetch failed: ${e.message} */`);
      break;
    }
  }
  return out;
}

function polygonCentroid(coords) {
  const ring = coords[0];
  if (!ring || ring.length < 3) return null;
  let sumX = 0, sumY = 0, n = 0;
  for (const p of ring) {
    sumX += p[0];
    sumY += p[1];
    n++;
  }
  return n > 0 ? [sumX / n, sumY / n] : null;
}

function escapeSql(val) {
  if (val == null) return 'NULL';
  const s = String(val).replace(/'/g, "''");
  return `'${s}'`;
}

async function main() {
  console.error('Fetching BC Rec Sites (points)...');
  const pointFeatures = await fetchArcGISPaginated(BC_REC_SITES_URL, 'BC Rec Sites');
  console.error('Fetching BC Rec Polygons...');
  const polyFeatures = await fetchArcGISPaginated(BC_REC_POLYGONS_URL, 'BC Rec Polygons');

  const byForestFileId = new Map();

  for (const f of pointFeatures) {
    if (f.geometry?.type !== 'Point' || !f.geometry.coordinates) continue;
    const fid = f.properties?.FOREST_FILE_ID;
    if (!fid || typeof fid !== 'string') continue;
    const [lon, lat] = f.geometry.coordinates;
    const key = fid.trim();
    if (!byForestFileId.has(key)) {
      byForestFileId.set(key, { lon, lat, forestFileId: key });
    }
  }

  for (const f of polyFeatures) {
    let coords = null;
    if (f.geometry?.type === 'Polygon') coords = f.geometry.coordinates;
    else if (f.geometry?.type === 'MultiPolygon') coords = f.geometry.coordinates?.[0];
    const centroid = coords ? polygonCentroid(coords) : null;
    if (!centroid) continue;
    const fid = f.properties?.FOREST_FILE_ID;
    if (!fid || typeof fid !== 'string') continue;
    const [lon, lat] = centroid;
    const key = fid.trim();
    if (!byForestFileId.has(key)) {
      byForestFileId.set(key, { lon, lat, forestFileId: key });
    }
  }

  const mapping = [...byForestFileId.values()];
  console.error(`Collected ${mapping.length} unique FOREST_FILE_IDs`);

  console.log(`-- Update RSTBC rec site booking_url to per-site sitesandtrailsbc.ca resource URLs
-- Generated by: node scripts/generate-rstbc-booking-urls.mjs

CREATE TEMP TABLE IF NOT EXISTS _rstbc_url_mapping (
  longitude DOUBLE PRECISION,
  latitude DOUBLE PRECISION,
  forest_file_id TEXT PRIMARY KEY
);

INSERT INTO _rstbc_url_mapping (longitude, latitude, forest_file_id) VALUES
`);

  const rows = mapping.map(
    (m) => `  (${m.lon}, ${m.lat}, ${escapeSql(m.forestFileId)})`
  );
  console.log(rows.join(',\n'));
  console.log(`
ON CONFLICT (forest_file_id) DO NOTHING;

UPDATE locations l
SET booking_url = 'https://www.sitesandtrailsbc.ca/resource/' || sub.forest_file_id
FROM (
  SELECT DISTINCT ON (l2.id) l2.id, m2.forest_file_id
  FROM locations l2
  CROSS JOIN LATERAL (
    SELECT m3.forest_file_id
    FROM _rstbc_url_mapping m3
    WHERE ST_DWithin(l2.coordinates, ST_SetSRID(ST_MakePoint(m3.longitude, m3.latitude), 4326)::geography, 1000)
    ORDER BY l2.coordinates <-> ST_SetSRID(ST_MakePoint(m3.longitude, m3.latitude), 4326)::geography
    LIMIT 1
  ) m2
  WHERE l2.provider = 'rstbc' AND l2.type = 'rec_site'
) sub
WHERE l.id = sub.id;

DROP TABLE IF EXISTS _rstbc_url_mapping;
`);
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
