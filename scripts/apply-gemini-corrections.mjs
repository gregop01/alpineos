#!/usr/bin/env node
/**
 * Generate a SQL migration from Gemini corrections.
 * Run after review-with-gemini.mjs.
 *
 * Usage: node scripts/apply-gemini-corrections.mjs
 * Output: prints SQL to stdout; redirect to supabase/migrations/XXX_correct_coordinates_from_gemini.sql
 */

import { readFileSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));

function escapeSql(str) {
  if (str == null) return 'NULL';
  return "'" + String(str).replace(/'/g, "''") + "'";
}

function main() {
  const path = join(__dirname, 'exports', 'gemini-corrections.json');
  let data;
  try {
    data = JSON.parse(readFileSync(path, 'utf8'));
  } catch (e) {
    console.error('Run review-with-gemini.mjs first to generate gemini-corrections.json');
    process.exit(1);
  }

  const corrections = data.corrections || [];
  const additions = data.additions || [];
  if (corrections.length === 0 && additions.length === 0) {
    console.log('-- No corrections or additions to apply');
    return;
  }

  console.log(`-- Apply ${corrections.length} coordinate corrections and ${additions.length} missing campsite additions`);
  console.log(`-- Source: ${data.source_export || 'locations-export.json'}, reviewed: ${data.reviewed_at || 'unknown'}`);
  console.log('-- Generated by scripts/apply-gemini-corrections.mjs');
  console.log('');

  additions.forEach((a) => {
    const lat = parseFloat(a.lat);
    const lon = parseFloat(a.lon);
    if (isNaN(lat) || isNaN(lon)) return;
    const name = (a.name || '').replace(/'/g, "''");
    const provider = (a.provider || 'bcparks').replace(/'/g, "''");
    const type = (a.type || 'campsite').replace(/'/g, "''");
    const meta = { coord_added_by: 'gemini', coord_reason: (a.reason || '').slice(0, 200) };
    const metaJson = JSON.stringify(meta).replace(/'/g, "''");
    const prov = a.provider || 'bcparks';
    const bookingUrls = {
      bcparks: 'https://camping.bcparks.ca/',
      parks_canada: 'https://reservation.pc.gc.ca/',
      wa_state_parks: 'https://washington.goingtocamp.com',
      rstbc: 'https://www2.gov.bc.ca/gov/content/sports-culture/recreation/camping-hiking/sites-trails',
      bc_coastal: 'https://www2.gov.bc.ca/gov/content/sports-culture/recreation/camping-hiking/sites-trails',
      acc: 'https://alpineclubofcanada.ca/huts/',
      bcmc: 'https://www.bcmc.ca/',
      voc: 'https://www.ubc-voc.com/',
      spearhead_huts: 'https://spearheadhuts.org',
      cvhs: 'https://cvhsinfo.org',
      pwa: 'https://pembertonwildlifeassociation.com',
      tetrahedron: 'https://www.tetoutdoor.ca',
      sct: 'https://sunshinecoasttrail.com',
      commercial: null,
      other: null,
    };
    const bookingUrl = bookingUrls[prov] ?? 'https://bcparks.ca/find-a-park/';
    console.log(`-- ADD: ${a.name} (${a.provider}) - ${a.reason || ''}`);
    const urlSql = bookingUrl ? escapeSql(bookingUrl) : 'NULL';
    console.log(
      `INSERT INTO locations (name, provider, coordinates, type, capacity_total, booking_url, metadata) SELECT ${escapeSql(name)}, ${escapeSql(provider)}, ST_SetSRID(ST_MakePoint(${lon}, ${lat}), 4326)::geography, ${escapeSql(type)}, ${a.capacity_total ?? 'NULL'}, ${urlSql}, '${metaJson}'::jsonb WHERE NOT EXISTS (SELECT 1 FROM locations WHERE LOWER(TRIM(name)) = LOWER(TRIM(${escapeSql(a.name)})) AND provider = ${escapeSql(provider)});`
    );
    console.log('');
  });

  if (additions.length > 0) console.log('');

  corrections.forEach((c) => {
    const lat = parseFloat(c.lat);
    const lon = parseFloat(c.lon);
    if (isNaN(lat) || isNaN(lon)) return;
    const orig = c.original_lat != null && c.original_lon != null
      ? ` BEFORE: (${c.original_lat}, ${c.original_lon})`
      : '';
    const reason = (c.reason || '').slice(0, 100).replace(/\\/g, '\\\\').replace(/"/g, '\\"');
    const metaJson = JSON.stringify({
      coord_corrected_by: 'gemini',
      coord_reason: reason || null,
      coord_original_lat: c.original_lat ?? null,
      coord_original_lon: c.original_lon ?? null,
    }).replace(/'/g, "''");
    console.log(`-- ${(c.name || c.id).toString().replace(/--/g, '')} (${c.provider || '?'})${orig}`);
    console.log(`-- Reason: ${(c.reason || '').replace(/--/g, '')}`);
    console.log(
      `UPDATE locations SET coordinates = ST_SetSRID(ST_MakePoint(${lon}, ${lat}), 4326)::geography, metadata = COALESCE(metadata, '{}'::jsonb) || '${metaJson}'::jsonb WHERE id = ${escapeSql(c.id)};`
    );
    console.log('');
  });
}

main();
